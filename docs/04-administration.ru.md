# 4. Администрирование и эксплуатация

## 4.1. Основные команды управления

Все основные операции удобно выполнять с помощью `Makefile`.

- **Запуск/остановка стека:**
  ```bash
  make up       # Собрать и запустить все сервисы в фоновом режиме
  make down     # Остановить и удалить все контейнеры
  make restart  # Перезапустить все сервисы
  ```
- **Работа с логами и состоянием:**
  ```bash
  make status   # Показать статус всех контейнеров
  make logs     # Показать и отслеживать логи сервиса loggate-service
  ```
- **Управление данными:**
  ```bash
  make clean    # ОСТОРОЖНО: Останавливает сервисы и УДАЛЯЕТ ВСЕ ДАННЫЕ (volumes)
  ```
- **Отладка:**
  ```bash
  make shell    # Открыть shell внутри контейнера loggate-service
  ```

## 4.2. Резервное копирование и восстановление

Скрипты `scripts/backup.sh` и `scripts/restore.sh` позволяют выполнять "холодное" резервное копирование данных Loki.

### Создание бэкапа

Команда создает `*.tar.gz` архив с данными Loki в директории `backups/`.

```bash
make backup
```

**Процесс:**

1.  Проверяет наличие утилиты `jq`.
2.  Находит имя Docker-тома, используемого Loki.
3.  Останавливает `loki` и `promtail` для обеспечения целостности данных.
4.  Запускает временный контейнер, который архивирует содержимое тома.
5.  Запускает `loki` и `promtail` обратно.

### Восстановление из бэкапа

**ВНИМАНИЕ:** Эта операция является деструктивной и полностью перезапишет текущие данные Loki.

```bash
# Восстановление из самого свежего бэкапа в папке backups/
make restore

# Восстановление из конкретного файла
make restore BACKUP_FILE=backups/loki-backup-YYYY-MM-DD_HH-MM-SS.tar.gz
```

**Процесс:**

1.  Запрашивает подтверждение у пользователя.
2.  Останавливает `loki` и `promtail`.
3.  **Полностью очищает** текущий том с данными Loki.
4.  Распаковывает указанный архив в том.
5.  Запускает сервисы.

## 4.3. Мониторинг

Основной инструмент мониторинга — дашборд `LogGate Application` в Grafana (`http://localhost:3000`).

### Панели дашборда

<!-- МЕСТО ДЛЯ СКРИНШОТА: Общий вид дашборда Grafana -->

**[ВСТАВИТЬ СКРИНШОТ ДАШБОРДА ЗДЕСЬ]**

- **Key Metrics (Статистика):**
  - `Total Log Rate`: Общее количество строк логов в секунду. Показывает общую нагрузку на систему.
  - `Error Rate`: Количество логов с уровнями `error`, `crit`, `fatal`. Ключевой показатель здоровья приложений.
  - `Loggate Goroutines`: Количество горутин в `loggate-service`. Резкий рост может указывать на утечки или блокировки.
  - `Loggate Memory (Alloc)`: Объем памяти, выделенный `loggate-service`.

- **Visualizations (Визуализации):**
  - `Log Volume by Level`: Распределение логов по уровням во времени. Помогает выявить аномалии (например, внезапный всплеск ошибок).
    <!-- МЕСТО ДЛЯ СКРИНШОТА: График Log Volume by Level -->

    **[ВСТАВИТЬ СКРИНШОТ ГРАФИКА "LOG VOLUME BY LEVEL" ЗДЕСЬ]**

  - `Log Distribution by Service`: Круговая диаграмма, показывающая, какие сервисы генерируют больше всего логов за выбранный период.

- **Logs Panel (Панель логов):**
  - Интерактивная панель для просмотра и поиска логов в реальном времени.
  - Используйте переменные вверху дашборда (`Application`, `Service`, `Level`) для быстрой фильтрации по индексированным меткам.
  - Используйте поле `Log Search` для полнотекстового поиска по содержимому логов (медленнее, чем фильтры).
    <!-- МЕСТО ДЛЯ СКРИНШОТА: Панель логов с примером фильтрации -->
    **[ВСТАВИТЬ СКРИНШОТ ПАНЕЛИ ЛОГОВ ЗДЕСЬ]**

### Ручная проверка и запросы

Используйте вкладку **Explore** в Grafana для выполнения произвольных LogQL-запросов к Loki.

**Примеры запросов:**

```logql
# Найти все логи от auth-service с уровнем ERROR
{service="auth-service", level="error"}

# Найти все логи, содержащие "failed to connect" (поиск по тексту, медленный)
{app="user-management"} |= "failed to connect"

# Посчитать количество логов в минуту, сгруппировав по сервису
sum by (service) (rate({app="e-commerce"}[1m]))
```

## 4.4. Устранение неисправностей

- **LogGate не принимает логи:**
  1.  Проверьте логи самого сервиса: `make logs`.
  2.  Убедитесь, что порт `10514/udp` не занят другим процессом на хосте.
  3.  Отправьте тестовый пакет вручную с помощью `netcat` и проверьте логи:
      ```bash
      echo '{"app": "test", "service": "manual", "level": "INFO", "message": "hello from netcat"}' | nc -u -w0 127.0.0.1 10514
      ```
- **Логи не появляются в Grafana:**
  1.  Проверьте логи `promtail`: `docker-compose logs -f promtail`. Ищите ошибки парсинга JSON или подключения к Loki.
  2.  Проверьте логи `loki`: `docker-compose logs -f loki`.
  3.  Убедитесь, что в Grafana (раздел Data Sources) корректно настроены и работают источники данных Prometheus и Loki.

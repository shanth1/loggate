# 2. Установка и запуск

## 2.1. Требования

- **Docker Engine:** Версия 20.10.0+
- **Docker Compose:** Версия 1.29.0+ (или `docker compose` v2+)
- **GNU Make:** Для удобного использования команд из `Makefile`.
- **Go:** Версия 1.23+ (только для использования генератора логов `loggen`).
- **Git:** Для клонирования репозитория.

## 2.2. Локальный запуск (для разработки)

Этапы ниже разворачивают полный стек LogGate на локальной машине.

### Шаг 1: Клонирование репозитория

```bash
git clone <your-repository-url>
cd loggate
```

### Шаг 2: Создание файла окружения

Создайте `.env` файл из шаблона. Для локальной разработки стандартные значения подходят.

```bash
cp .env.example .env
```

> **Примечание:** В `.env` файле `DOCKER_HOST_BIND_IP` по умолчанию установлен в `0.0.0.0`, что делает сервисы доступными со всех сетевых интерфейсов вашей машины. Для production рекомендуется изменить это значение на `127.0.0.1`.

### Шаг 3: Сборка и запуск

Используйте `make` для запуска всех сервисов. Команда `up` автоматически соберет образ `loggate` и запустит все контейнеры в фоновом режиме.

```bash
make up
```

### Шаг 4: Проверка состояния

Убедитесь, что все контейнеры успешно запустились и находятся в состоянии `Up` или `running`.

```bash
make status
# или
docker-compose ps
```

### Шаг 5: Генерация тестовых данных

Чтобы проверить систему, запустите встроенный генератор логов. Он будет отправлять UDP-пакеты на `localhost:10514` в соответствии с конфигурацией `cmd/loggen/config/config.yaml`.

```bash
make gen-logs
```

Вы также можете отправить единичный тестовый лог:

```bash
make test-log
```

### Шаг 6: Доступ к веб-интерфейсам

- **Grafana:** [http://localhost:3000](http://localhost:3000)
  - **Login:** `admin`
  - **Password:** `admin` (или значение `GRAFANA_ADMIN_PASSWORD` из `.env`)
  - Дашборд `LogGate Application` уже будет настроен и доступен.
- **Prometheus:** [http://localhost:9090](http://localhost:9090)
  - Проверьте статус целей (Targets) для `loggate`, `loki` и др.
- **cAdvisor:** [http://localhost:8080](http://localhost:8080)
  - Просмотр метрик производительности контейнеров.

## 2.3. Развертывание в Production

Переход в production требует дополнительных шагов для обеспечения безопасности, стабильности и надежности.

1.  **Конфигурация `.env`:**
    - **ОБЯЗАТЕЛЬНО:** Установите сложный и уникальный пароль `GRAFANA_ADMIN_PASSWORD`.
    - Установите `DOCKER_HOST_BIND_IP=127.0.0.1`. Это ограничит доступ к портам (Prometheus, Loki и др.) только с хост-машины. Доступ к Grafana должен осуществляться через обратный прокси (Nginx, Traefik) с настроенным HTTPS.
    - Раскомментируйте и настройте лимиты ресурсов (CPU, Memory) для каждого сервиса в соответствии с возможностями вашего сервера.

2.  **Конфигурация `config/config.yaml`:**
    - Настройте реальные хранилища (например, `clickhouse_main`), указав корректные DSN и учетные данные. Рекомендуется использовать переменные окружения для секретов.
    - Отключите `console_debug` (`enabled: false`), чтобы избежать лишней нагрузки на систему логирования Docker.

3.  **Управление данными (Volumes):**
    - Данные сервисов (`prometheus_data`, `loki_data`, `grafana_data`) хранятся в Docker-томах на хост-машине. Убедитесь, что на диске достаточно места.
    - Настройте регулярное резервное копирование этих томов. См. раздел [Администрирование](04-administration.md#42-резервное-копирование-и-восстановление).

4.  **Запуск:**
    - Перед запуском в production всегда пересобирайте образы с последними изменениями.
    ```bash
    # Убедитесь, что вы в корне проекта с docker-compose.yaml
    docker-compose build
    docker-compose up -d
    ```
